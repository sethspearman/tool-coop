@page "/t/{TenantSlug}/admin/members"
@attribute [Authorize(Roles = "Admin,Manager")]
@inject MemberApiService MemberApi

<PageTitle>Members — Tool Co-op</PageTitle>

<h4 class="fw-semibold mb-4">Members</h4>

@if (loading)
{
    <LoadingSpinner />
}
else
{
    <div class="card shadow-sm">
        <div class="card-body p-0">
            <div class="table-responsive">
                <table class="table table-hover mb-0">
                    <thead class="table-light">
                        <tr>
                            <th>Name</th>
                            <th>Email</th>
                            <th>Role</th>
                            <th>Status</th>
                            <th>Joined</th>
                        </tr>
                    </thead>
                    <tbody>
                        @foreach (var m in members)
                        {
                            <tr>
                                <td>
                                    @if (m.User?.AvatarUrl is not null)
                                    {
                                        <img src="@m.User.AvatarUrl" class="rounded-circle me-2"
                                             width="28" height="28" alt="" />
                                    }
                                    @(m.User?.DisplayName ?? "—")
                                </td>
                                <td class="text-muted small">@(m.User?.Email ?? "—")</td>
                                <td>
                                    <AuthorizeView Roles="Admin">
                                        <Authorized>
                                            <select class="form-select form-select-sm"
                                                    style="width: auto;"
                                                    value="@m.Role"
                                                    @onchange="e => ChangeRole(m, e.Value?.ToString()!)">
                                                <option>Member</option>
                                                <option>Manager</option>
                                                <option>Admin</option>
                                                <option>Guest</option>
                                            </select>
                                        </Authorized>
                                        <NotAuthorized>
                                            <span class="badge @RoleBadge(m.Role)">@m.Role</span>
                                        </NotAuthorized>
                                    </AuthorizeView>
                                </td>
                                <td>
                                    <select class="form-select form-select-sm"
                                            style="width: auto;"
                                            value="@m.Status"
                                            @onchange="e => ChangeStatus(m, e.Value?.ToString()!)">
                                        <option>Active</option>
                                        <option>Pending</option>
                                        <option>Banned</option>
                                    </select>
                                </td>
                                <td class="text-muted small">
                                    @m.JoinedUtc.LocalDateTime.ToString("MMM d, yyyy")
                                </td>
                            </tr>
                        }
                    </tbody>
                </table>
            </div>
        </div>
    </div>

    @if (toast is not null)
    {
        <div class="toast-container position-fixed bottom-0 end-0 p-3">
            <div class="toast show align-items-center text-bg-@(toastOk ? "success" : "danger")">
                <div class="d-flex">
                    <div class="toast-body">@toast</div>
                    <button type="button" class="btn-close btn-close-white me-2 m-auto"
                            @onclick="() => toast = null"></button>
                </div>
            </div>
        </div>
    }
}

@code {
    [Parameter] public string TenantSlug { get; set; } = "";

    private List<TenantMember> members = [];
    private bool   loading  = true;
    private string? toast   = null;
    private bool   toastOk  = true;

    protected override async Task OnInitializedAsync()
    {
        members = await MemberApi.ListAsync();
        loading = false;
    }

    private async Task ChangeRole(TenantMember m, string role)
    {
        var ok = await MemberApi.UpdateRoleAsync(m.UserId, role);
        if (ok) m.Role = role;
        ShowToast(ok, ok ? $"{m.User?.DisplayName} is now {role}." : "Failed to update role.");
    }

    private async Task ChangeStatus(TenantMember m, string status)
    {
        var ok = await MemberApi.UpdateStatusAsync(m.UserId, status);
        if (ok) m.Status = status;
        ShowToast(ok, ok ? "Status updated." : "Failed to update status.");
    }

    private void ShowToast(bool ok, string msg)
    {
        toast   = msg;
        toastOk = ok;
        StateHasChanged();
    }

    private static string RoleBadge(string role) => role switch
    {
        "Admin"   => "bg-danger",
        "Manager" => "bg-warning text-dark",
        "Member"  => "bg-primary",
        _         => "bg-secondary"
    };
}
